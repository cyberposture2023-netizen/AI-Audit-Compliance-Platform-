<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Analytics - Compliance Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .analytics-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .score-metric {
            font-size: 2.5em;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
        .score-excellent { color: #10B981; }
        .score-good { color: #3B82F6; }
        .score-fair { color: #F59E0B; }
        .score-poor { color: #EF4444; }
        .back-button {
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <div class="back-button">
            <a href="/" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded inline-flex items-center">
                ← Back to Main Platform
            </a>
        </div>
        
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Advanced Compliance Analytics</h1>
        
        <!-- Overall Compliance Score -->
        <div class="analytics-card mb-6">
            <h2 class="text-xl font-semibold mb-4">Overall Compliance Health</h2>
            <div class="analytics-grid">
                <div class="text-center">
                    <div id="overallScore" class="score-metric score-good">0%</div>
                    <p class="text-gray-600">Overall Compliance</p>
                </div>
                <div class="text-center">
                    <div id="implementationScore" class="score-metric">0%</div>
                    <p class="text-gray-600">Implementation</p>
                </div>
                <div class="text-center">
                    <div id="testingScore" class="score-metric">0%</div>
                    <p class="text-gray-600">Testing Coverage</p>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="analytics-grid">
            <!-- Compliance Trend -->
            <div class="analytics-card">
                <h3 class="text-lg font-semibold mb-4">Compliance Trend</h3>
                <canvas id="trendChart" height="200"></canvas>
            </div>
            
            <!-- Risk Heat Map -->
            <div class="analytics-card">
                <h3 class="text-lg font-semibold mb-4">Risk Heat Map</h3>
                <canvas id="riskChart" height="200"></canvas>
            </div>
            
            <!-- Framework Comparison -->
            <div class="analytics-card">
                <h3 class="text-lg font-semibold mb-4">Framework Coverage</h3>
                <canvas id="frameworkChart" height="200"></canvas>
            </div>
            
            <!-- Control Status -->
            <div class="analytics-card">
                <h3 class="text-lg font-semibold mb-4">Control Status</h3>
                <canvas id="controlChart" height="200"></canvas>
            </div>
        </div>

        <!-- Gap Analysis -->
        <div class="analytics-card mt-6">
            <h2 class="text-xl font-semibold mb-4">Gap Analysis Report</h2>
            <div id="gapAnalysis" class="space-y-3">
                <div class="text-center py-4 text-gray-500">
                    Loading gap analysis...
                </div>
            </div>
        </div>

        <!-- Export Options -->
        <div class="analytics-card mt-6">
            <h2 class="text-xl font-semibold mb-4">Export Reports</h2>
            <div class="flex space-x-4">
                <button onclick="exportReport('pdf')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                    Export PDF Report
                </button>
                <button onclick="exportReport('excel')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                    Export Excel Data
                </button>
                <button onclick="exportReport('executive')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                    Executive Summary
                </button>
            </div>
            <div id="exportStatus" class="mt-3 text-sm"></div>
        </div>
    </div>

    <script>
        // Load analytics data
        async function loadAnalytics() {
            try {
                console.log('Loading analytics data...');
                
                const response = await fetch('/api/analytics/compliance-score');
                if (!response.ok) {
                    throw new Error('API response not OK');
                }
                const data = await response.json();
                
                console.log('Analytics data loaded:', data);
                
                // Update score metrics
                document.getElementById('overallScore').textContent = data.overall_score + '%';
                document.getElementById('implementationScore').textContent = data.implementation_score + '%';
                document.getElementById('testingScore').textContent = data.testing_score + '%';
                
                // Set score colors
                setScoreColor('overallScore', data.overall_score);
                setScoreColor('implementationScore', data.implementation_score);
                setScoreColor('testingScore', data.testing_score);
                
                // Load charts
                loadCharts(data);
                loadGapAnalysis();
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                // Set demo data if API fails
                setDemoData();
            }
        }

        function setDemoData() {
            document.getElementById('overallScore').textContent = '85%';
            document.getElementById('implementationScore').textContent = '78%';
            document.getElementById('testingScore').textContent = '65%';
            
            setScoreColor('overallScore', 85);
            setScoreColor('implementationScore', 78);
            setScoreColor('testingScore', 65);
            
            loadCharts({
                overall_score: 85,
                implementation_score: 78,
                testing_score: 65,
                total_controls: 50,
                implemented_controls: 39,
                tested_controls: 32,
                passed_controls: 42
            });
            
            // Load demo gap analysis
            document.getElementById('gapAnalysis').innerHTML = \
                <div class="border-l-4 border-red-500 pl-4 py-2">
                    <h4 class="font-semibold">SOC 2 - Access Management</h4>
                    <p class="text-sm text-gray-600">Multi-factor authentication not implemented for admin accounts</p>
                    <p class="text-sm"><strong>Risk:</strong> High</p>
                </div>
                <div class="border-l-4 border-yellow-500 pl-4 py-2">
                    <h4 class="font-semibold">HIPAA - Data Encryption</h4>
                    <p class="text-sm text-gray-600">Encryption at rest not enabled for patient databases</p>
                    <p class="text-sm"><strong>Risk:</strong> Medium</p>
                </div>
            \;
        }

        function setScoreColor(elementId, score) {
            const element = document.getElementById(elementId);
            element.className = 'score-metric ';
            if (score >= 90) element.classList.add('score-excellent');
            else if (score >= 75) element.classList.add('score-good');
            else if (score >= 50) element.classList.add('score-fair');
            else element.classList.add('score-poor');
        }

        function loadCharts(data) {
            // Trend Chart
            try {
                new Chart(document.getElementById('trendChart'), {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Compliance Score',
                            data: [65, 70, 75, 80, 85, data.overall_score],
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            } catch (e) {
                console.error('Trend chart error:', e);
            }

            // Risk Chart
            try {
                new Chart(document.getElementById('riskChart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['High Risk', 'Medium Risk', 'Low Risk'],
                        datasets: [{
                            data: [15, 25, 60],
                            backgroundColor: ['#EF4444', '#F59E0B', '#10B981']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            } catch (e) {
                console.error('Risk chart error:', e);
            }

            // Framework Chart
            try {
                new Chart(document.getElementById('frameworkChart'), {
                    type: 'bar',
                    data: {
                        labels: ['SOC 2', 'HIPAA', 'NIST', 'ISO 27001'],
                        datasets: [{
                            label: 'Implementation %',
                            data: [85, 70, 60, 75],
                            backgroundColor: '#3B82F6'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            } catch (e) {
                console.error('Framework chart error:', e);
            }

            // Control Status Chart
            try {
                const notStarted = data.total_controls - data.implemented_controls - 15;
                new Chart(document.getElementById('controlChart'), {
                    type: 'pie',
                    data: {
                        labels: ['Implemented', 'In Progress', 'Not Started'],
                        datasets: [{
                            data: [data.implemented_controls, 15, Math.max(0, notStarted)],
                            backgroundColor: ['#10B981', '#F59E0B', '#EF4444']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            } catch (e) {
                console.error('Control chart error:', e);
            }
        }

        async function loadGapAnalysis() {
            try {
                const response = await fetch('/api/analytics/gap-analysis');
                if (!response.ok) {
                    throw new Error('Gap analysis API failed');
                }
                const gaps = await response.json();
                
                const container = document.getElementById('gapAnalysis');
                if (gaps.length > 0) {
                    container.innerHTML = gaps.map(gap => \
                        <div class="border-l-4 \ pl-4 py-2">
                            <h4 class="font-semibold">\ - \</h4>
                            <p class="text-sm text-gray-600">\</p>
                            <p class="text-sm"><strong>Risk:</strong> \ | <strong>Status:</strong> \ | <strong>Test Result:</strong> \</p>
                        </div>
                    \).join('');
                } else {
                    container.innerHTML = '<div class="text-center py-4 text-green-500">No significant compliance gaps found!</div>';
                }
            } catch (error) {
                console.error('Error loading gap analysis:', error);
                document.getElementById('gapAnalysis').innerHTML = '<div class="text-center py-4 text-yellow-500">Unable to load gap analysis. Using demo data.</div>';
            }
        }

        async function exportReport(format) {
            const statusElement = document.getElementById('exportStatus');
            try {
                statusElement.innerHTML = '<div class="text-blue-500">Generating report...</div>';
                
                const response = await fetch(\/api/reports/export/\\, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    statusElement.innerHTML = \<div class="text-green-500">✅ \</div>\;
                } else {
                    statusElement.innerHTML = '<div class="text-red-500">❌ Error generating report</div>';
                }
            } catch (error) {
                console.error('Export error:', error);
                statusElement.innerHTML = \<div class="text-green-500">✅ \ report generated successfully! (Demo)\</div>\;
            }
        }

        // Initialize analytics on load
        document.addEventListener('DOMContentLoaded', loadAnalytics);
    </script>
</body>
</html>
